# ジョブカン交通費申請チェック Chrome拡張機能 設計書

## 1. 機能要件

### チェック項目

#### 日付の重複チェック
- 同じ日に同じルート（出発地 → 到着地）が重複していないか
- 重複時は最後の申請を保持対象、それ以前を削除対象として明示

#### 休日・祝日申請チェック
- [holidays-jp API](https://holidays-jp.github.io/) を参照して祝日を判定
- 申請日が **土曜 / 日曜 / 国民の祝日** に該当する場合、目的や備考欄に以下のキーワードがあるか確認:
  - 「休日出勤」
  - 「出張」
  - 「緊急対応」
  - 「出社」
- キーワードがない場合はエラーとして検出

#### 連続性チェック（推奨項目）
- 平日に交通費申請の抜けがないか検知
- 抜けがある場合は警告として表示

#### 金額の不一致チェック
- 同じルート（出発地 → 到着地）+ 往復/片道 で金額が異なる申請を検出
- 最頻値を正常値とし、異なる金額のみをエラーとして表示

## 2. アーキテクチャ設計

### 構成要素（Manifest v3）

| ファイル | 役割 |
|---------|------|
| **manifest.json** | 権限・拡張機能設定、CSP設定 |
| **content.js** | ジョブカン画面からデータ抽出、サニタイゼーション処理 |
| **background.js** | 祝日データ取得・各種チェックロジック |
| **popup.html / popup.js** | サイドパネルUI、結果表示 |

### データフロー

```
1. content.js (コンテンツスクリプト)
   ↓
   - ジョブカン交通費画面のテーブルをDOMパース
   - データをサニタイズ（HTMLタグ除去、特殊文字エスケープ）
   - JSON形式で抽出: {date, from, to, roundTrip, amount, purpose, remarks, rowId}
   ↓
2. background.js (サービスワーカー)
   ↓
   - holidays-jp APIから祝日データ取得（24時間キャッシュ）
   - APIレスポンス検証（オブジェクト形式、日付形式チェック）
   - 各種チェック実行:
     * 日付重複チェック
     * 休日/祝日申請チェック
     * 連続性チェック
     * 金額不一致チェック
   ↓
3. popup.js (サイドパネルUI)
   ↓
   - チェック結果をtextContentで安全に表示（XSS対策）
   - 結果の並び替え機能（日付昇順/降順）
   - 該当行へのスクロール＆ハイライト機能
```

### ステータス表示

- ❌ **問題あり**: 必須対応事項（重複、休日申請、金額不一致）
- ⚠️ **要確認事項**: 推奨対応（連続性抜け）
- ✅ **問題なし**: 全チェック通過

## 3. 処理フロー詳細

### A. 日付の重複チェック
1. 申請日 + ルート（出発→到着）をキーにMapを構築
2. 同じキーで複数申請がある場合:
   - 最後の申請 → ✅ **保持対象**
   - それ以前 → 🗑️ **削除対象**
3. 同じ日付の重複をグループ化して表示

### B. 休日・祝日チェック
1. **判定ロジック**:
   - `Date.getDay()` で土曜(6) / 日曜(0) を判定
   - holidays-jp APIの祝日データに含まれるか確認
2. **休日/祝日の場合**:
   - 備考欄に正当キーワードがあるか確認:
     - `['休日出勤', '出張', '緊急対応', '出社']`
   - キーワードがなければ → ❌

### C. 連続性チェック
1. 申請日を昇順ソート
2. 日付間の差分を計算
3. 間に平日（土日祝を除く）が存在する場合 → ⚠️
4. 抜けている平日の日付範囲を表示

### D. 金額の不一致チェック
1. ルート（出発→到着:往復/片道）ごとに金額を集計
2. 最頻値を正常金額として判定
3. 正常金額と異なる申請のみエラー表示 → ❌

## 4. UI機能

### 主要機能
- **チェック開始ボタン**: 手動でチェックを実行
- **自動チェック機能**: ページ変更を1.5秒ごとに検知して自動実行
- **並び替え機能**: 日付昇順/降順でソート（安定ソート）
- **修正ボタン**: 該当行にスクロール＆3秒間ハイライト表示

### 出力例

#### ❌ 問題あり（重複申請）
```
🗑️ 削除対象                              [修正する]
日付: 2025-10-01
❌ 削除対象
重複を削除してください
───────────────────────────────
✅ 保持対象                              [表示する]
日付: 2025-10-01
✅ 保持対象
2件の重複があります
```

#### ❌ 問題あり（休日申請）
```
❌                                      [修正する]
日付: 2025-10-13
問題内容: 休日申請
詳細: 祝日の申請です
対応: 備考欄には出勤理由を記入するか、不要な場合は削除してください
```

#### ❌ 問題あり（金額不一致）
```
❌                                      [修正する]
日付: 2025-10-15
問題内容: 金額不一致
詳細: 「渋谷→新宿（往復）」の金額が他の申請と異なります: 300円（他の申請: 320円）
対応: 金額を確認してください
```

#### ⚠️ 要確認事項（連続性）
```
⚠️
日付: 2025-10-02 ～ 2025-10-04
問題内容: 連続性抜け
詳細: 平日に交通費申請が抜けています（2日分）
対応: 実際に出勤が無かったか確認してください
```

#### ✅ 問題なし
```
✅ 問題はありません
```

### 総合判定例
```
承認可否: ❌ 要修正
問題: 5件 / 警告: 1件
```

## 5. セキュリティ対策

### 実装済みセキュリティ機能

1. **XSS対策**
   - `innerHTML`を使用せず、`textContent`で安全にデータ表示
   - DOM要素を個別に生成して挿入

2. **入力データのサニタイゼーション**
   - HTMLタグの除去: `/<[^>]*>/g`
   - 特殊文字のエスケープ: `<>'"&` → `&lt;&gt;&quot;&#x27;&amp;`
   - content.jsの`sanitizeText()`関数で全データを処理

3. **Content Security Policy**
   - `script-src 'self'; object-src 'self'`
   - インラインスクリプト、外部スクリプトを禁止

4. **権限の最小化**
   - `host_permissions`を必要最小限に制限:
     - `https://ssl.jobcan.jp/*`
     - `https://ssl.wf.jobcan.jp/*`
     - `https://holidays-jp.github.io/*`
   - ワイルドカード `https://*.jobcan.jp/*` を削除

5. **APIレスポンス検証**
   - オブジェクト形式のチェック
   - 日付形式の検証（YYYY-MM-DD）
   - 不正なデータはフォールバックへ

## 6. 技術的参考資料

- [Chrome Extensions Manifest V3 公式ドキュメント](https://developer.chrome.com/docs/extensions/mv3/)
- [holidays-jp API](https://holidays-jp.github.io/)
- [MDN Date API](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Date)
- [Content Security Policy](https://developer.mozilla.org/ja/docs/Web/HTTP/CSP)