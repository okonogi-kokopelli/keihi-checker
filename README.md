# 概要

ジョブカンの交通費申請をチェックし、重複や休日申請の問題を自動検出する Chrome 拡張機能です。結果はサイドパネルで常時確認でき、ワンクリックで該当行へ移動して修正できます。

---

## できること（主要機能）

- **サイドパネル表示**: ページを見ながらチェック結果を常時確認
- **自動チェック**: DOM変更を即座に検知し、変更があった場合のみ再チェック（MutationObserver + デバウンス処理）
- **修正ボタン**: エラー項目から該当行へスクロールし3秒間ハイライト
- **日付ソート**: 昇順・降順の切り替え（デフォルトは昇順）
- **通勤交通費に特化**: 「オフィスへの通勤」テーブルのみ対象

## チェック項目

### 1. 休日・祝日申請チェック ❌（最優先）

- 土曜・日曜・国民の祝日の申請を検出
- 備考欄に「休日出勤」「出張」「緊急対応」「出社」等の正当な理由があるか確認
- **祝日エラーの申請は重複チェック対象から除外**（祝日エラーとしてのみ表示）

### 2. 日付の重複チェック ❌

- 同じ日・同じルート（出発地 → 到着地）の重複を検出
- **連続性・近接性を考慮した保持対象判定**:
  - 前後に異なる日付で挟まれている出現を優先保持
  - 全体配列の中央に近い位置を優先
  - 元の配列順序を維持して評価
- 「削除対象」「保持対象」を明確に区別して表示

### 3. 連続性チェック ⚠️（推奨）

- 平日の交通費申請に抜けがないか確認
- 土日・祝日を除外して判定

### 4. 金額の不一致チェック ❌

- 同一ルート（出発地→到着地）＋往復/片道で金額差がある申請を検出
- 最頻値を正常値とし、差異のみエラー表示

> 💡 **処理順序**: 祝日チェック → 重複チェック → 連続性チェック → 金額チェック
>
> 祝日エラーの申請は重複チェックから除外され、祝日エラーとしてのみ表示されます。 

---

## 判定結果の見方

- **✅ 問題なし**: エラーも警告もなし
- **❌ 問題あり**: 必須対応事項あり
- **⚠️ 要確認事項**: 推奨確認事項あり

### 表示例（問題なし）

```
承認可否: ✅ 承認可能
問題: 0件 / 警告: 0件

✅ 通勤交通費
✅ 問題はありません
```

### 表示例（問題あり）

```
承認可否: ❌ 要修正
問題: 3件 / 警告: 1件

❌ 通勤交通費

❌ 問題あり（必須対応）

🗑️ 日付: 2025/10/05               [修正する]
❌ 削除対象
重複を削除してください

🗑️ 日付: 2025/10/05               [修正する]
❌ 削除対象
重複を削除してください

──────────────────────────

✅ 日付: 2025/10/05               [表示する]
✅ 保持対象
2件の重複があります

日付: 2025/10/13               　　[修正する]
問題内容: 休日申請
詳細: 祝日に申請があります。備考欄に理由がありません。
対応: 備考欄に「休日出勤」等を記載してください

⚠️ 要確認事項（推奨）

日付: 2025/10/02 ～ 2025/10/04
問題内容: 連続性抜け
詳細: 平日に交通費申請が抜けています（2日分）
対応: 実際に出勤が無かったか確認してください
```

### ソート

- **日付 ↑**: 昇順（古い→新しい）
- **日付 ↓**: 降順（新しい→古い）
- 既定は昇順

---

## セットアップ手順

### 1. 前提条件

- Google Chrome または Chromium ベースのブラウザ
- ジョブカンのアカウント

### 2. インストール

1. Chrome で `chrome://extensions/` を開く
2. 右上の「デベロッパー モード」を有効化
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. 本プロジェクトのフォルダを選択
5. 拡張機能が読み込まれたことを確認

---

## 使い方

### 基本フロー

1. ジョブカンの交通費申請画面を開く（ログイン済み）
2. 拡張機能アイコン（🚆）をクリックしサイドパネルを開く
3. 「チェック開始」をクリック
4. 結果を確認し、必要に応じて修正

### 自動チェック

1. サイドパネルで「自動チェック（ページ変更を検知）」をオン
2. 交通費データを編集
3. 変更を即座に検知し、500ms後に自動更新（ローディングなしのスムーズ更新）
4. 連続した編集は自動的にまとめて1回のチェックに統合（デバウンス処理）

### 修正ボタン

- 「修正する」を押すと該当行へスクロールし、黄色背景＋オレンジ枠で3秒間ハイライト
- サイドパネルを開いたまま、その場で修正可能

---

## カスタマイズ

### 祝日データの更新（background.js）

```jsx
function getJapaneseHolidays(year) {
  const holidays = {
    2025: [
      '2025-01-01', // 元日
      '2025-01-13', // 成人の日
      // ... 他の祝日
    ],
    2026: [
      // 2026年の祝日
    ]
  };
  return holidays[year] || [];
}
```

### 休日出勤キーワード（background.js）

```jsx
const validKeywords = ['休日出勤', '出張', '緊急対応', '出社'];
```

### 自動チェック設定（content.js）

```jsx
// デバウンス時間（連続変更の待機時間）
}, 500); // 500ミリ秒 = 0.5秒

// フォールバック定期チェック間隔
}, 2000); // 2000ミリ秒 = 2秒
```

---

## トラブルシューティング

### データが見つからない

- 実行ページがジョブカンの交通費申請画面であることを確認
- 「オフィスへの通勤」テーブルの存在を確認
- ブラウザをリロード（F5）して再実行

### サイドパネルが開かない

- `chrome://extensions/` で拡張機能が有効か確認
- 拡張機能を再読み込み
- ジョブカンのページをリロード

### 自動チェックが動作しない

- 開発者ツール（F12）でエラーを確認
- 拡張機能を再読み込み
- ページをリロード
- 自動チェックを一度オフにして再オン
- コンソールで `MutationObserver` のログを確認
  - 「MutationObserver監視停止」が表示されていればObserverは正常
  - 「データ変更検知」が表示されれば検知は正常動作中

### 祝日判定が正しくない

- `background.js` の祝日データを最新年度に更新
- 年度が変わったら新しい年の祝日データを追加

---

## 技術仕様

### ファイル構成

```
keihi-checker/
├── manifest.json          # 拡張機能の設定（Manifest V3）
├── content.js             # DOM解析・データ抽出・自動チェック監視
├── background.js          # 祝日データ取得・チェックロジック
├── popup.html             # サイドパネルUI
├── popup.js               # サイドパネル制御
├── icon16.png             # アイコン (16x16)
├── icon48.png             # アイコン (48x48)
├── icon128.png            # アイコン (128x128)
├── CLAUDE.md              # 設計書
├── README.md              # 本ファイル
└── tests/                 # テストディレクトリ
    ├── tests.js           # テストランナー（全テスト一括実行）
    ├── test_duplicate_logic.js      # 重複検出ロジックのテスト
    ├── test_holiday_duplicate.js    # 祝日除外ロジックのテスト
    └── test_debug.js                # スコアリングのデバッグ表示
```

### データフロー

1. **content.js**: ジョブカン画面から通勤交通費データを抽出・サニタイズ
2. **content.js**: MutationObserverでDOM変更を即座に検知（自動チェック有効時）
   - デバウンス処理: 500ms以内の連続変更を1回にまとめる
   - フォールバック: 2秒ごとの定期チェック
   - 重複実行防止: チェック実行中は新規チェックをブロック
3. **background.js**: チェックロジックを実行
   - 祝日チェック（最優先）
   - 重複チェック（祝日エラー除外）
   - 連続性チェック
   - 金額チェック
4. **popup.js**: 結果をサイドパネルUIに安全に表示（XSS対策済み）

### 主な技術

- Manifest V3（最新の拡張機能API）
- Side Panel API（右側サイドパネル表示）
- MutationObserver（DOM変更のリアルタイム検知）
- デバウンス処理（連続変更の最適化）
- データスナップショット（変更検知の効率化）
- 安定ソート（同日付内の順序保持）

### 対応ブラウザ

- Google Chrome（推奨、バージョン114以降）
- Microsoft Edge
- その他 Chromium ベース（Side Panel API対応版）

---

## 重複チェックのロジック（詳細）

### アルゴリズム概要

同じ日付・同じルートの重複がある場合、**連続性・近接性を考慮したスコアリング**で保持対象を決定：

#### スコアリング基準

1. **両側挟まれ判定（スコア: 100）**
   - 前後に異なる日付が存在する出現を最優先
   - さらに、全体配列の中央に近いほど高評価（-0.1 × 中央距離）
   - 例: `10/06 → [10/08] → 10/09` の 10/08

2. **片側のみ判定（スコア: 50）**
   - 片側にのみ異なる日付が存在（連続性の端）
   - 配列の最初の方を優先（-0.5 × index）
   - 例: `[10/01] → 10/02` の 10/01

3. **前後なし判定（スコア: -index）**
   - 全て同じ日付が連続している場合
   - 最初の出現を保持

#### 実行例

```
元データ（index順）:
  0: 10/01
  1: 10/02
  2: 10/08  ← 前: 10/02, 後: 10/03（挟まれ、中央距離: 6.0）
  3: 10/03
  4: 10/04
  5: 10/06
  6: 10/08  ← 前: 10/06, 後: 10/09（挟まれ、中央距離: 2.0）✅ 最高スコア
  7: 10/09
  ...
 15: 10/01  ← 前: 10/08, 後: なし（片側のみ）

結果:
  - 10/08: index 6 を保持（最も中央的、スコア: 99.80）
  - 10/01: index 0 を保持（連続性の始点、スコア: 50.00）
```

### 処理フロー

1. **祝日チェック**: 祝日エラーの申請を記録（`holidayErrorRowIds`）
2. **重複チェック**: 祝日エラーを除外してグループ化
3. **スコアリング**: 各重複出現位置のスコアを計算
4. **保持判定**: 最高スコアの出現を保持対象とし、それ以外を削除対象に

---
## テスト

### テストの実行

全てのテストを一括実行：

```bash
node tests/tests.js
```

個別のテストファイルを実行：

```bash
node tests/test_duplicate_logic.js
node tests/test_holiday_duplicate.js
node tests/test_debug.js
```

### テストファイル

| ファイル | 内容 |
|---------|------|
| `tests/tests.js` | テストランナー（全テスト一括実行） |
| `tests/test_duplicate_logic.js` | 重複検出ロジックの検証（連続性・近接性考慮） |
| `tests/test_holiday_duplicate.js` | 祝日申請の重複チェック除外動作確認 |
| `tests/test_debug.js` | スコアリング詳細のデバッグ表示 |

### テスト結果の例

```
╔═══════════════════════════════════════════════════════════════════╗
║          ジョブカン交通費チェッカー - テストスイート実行          ║
╚═══════════════════════════════════════════════════════════════════╝

======================================================================
📝 テスト 1/3: test_debug.js
======================================================================

🔍 スコアリング詳細 (対象日付: 2025-10-08)
  [index:6] スコア:99.80 | 両側挟まれ (前:2025-10-06, 後:2025-10-09) 中央距離:2.0
  ✅ 最高スコア: [index:6] 99.80

✅ テスト完了: test_debug.js

══════════════════════════════════════════════════════════════════════
📊 テスト結果サマリー
══════════════════════════════════════════════════════════════════════
総テスト数: 3
✅ 成功: 3
❌ 失敗: 0
══════════════════════════════════════════════════════════════════════

🎉 全てのテストが成功しました！
```

---

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## サポート

問題が発生した場合や改善提案がある場合は、Issueを作成してください。

---

## 開発者向け情報

### 技術スタック

- **Manifest V3**: 最新のChrome拡張機能API
- **Side Panel API**: ブラウザ右側のサイドパネル表示
- **holidays-jp API**: 祝日データ取得（24時間キャッシュ）
- **Content Security Policy**: XSS対策（`script-src 'self'`）

### セキュリティ対策

1. **XSS対策**: `textContent`で安全にデータ表示（`innerHTML`不使用）
2. **入力サニタイズ**: HTMLタグ除去、特殊文字エスケープ
3. **権限の最小化**: 必要最小限のホスト権限のみ
4. **APIレスポンス検証**: オブジェクト形式・日付形式チェック

### 主要機能

- **自動チェック**: MutationObserver によるイベント駆動型検知
  - DOM変更を即座に検知（リアルタイム）
  - デバウンス処理: 500ms以内の連続変更を1回にまとめる
  - 重複実行防止: チェック実行中は新規チェックをブロック
  - フォールバック: 2秒ごとの定期チェック（念のため）
- **データスナップショット**: 主要データのみを抽出して効率化
- **安定ソート**: 同日付内の順序保持
- **スコアリングアルゴリズム**: 連続性・近接性を考慮した重複判定

### テスト

- `tests/` ディレクトリに格納
- `tests/tests.js` で全テストを一括実行
- アルファベット順にソートされて実行
